控制器性能基准测试
=============================

测试结果图对比
=========================

前提
---------------

__文件命名说明__:

* 软件交换机:  OVS (openvswitch)
* 硬件交换机:  盛科v350
* 测试图，x轴为并发数，y轴为每秒请求数（req/s）
* pw:预写流表到交换机
* nw:不预写流表，每次请求都要经过controller的转发模块
* lb:每次请求都要经过controller的负载均衡模块
* 采样步长：每隔100并发测试一次

__NOTE__:

* 原因分析，仅供参考;
* 所有测试结果，交换机和服务端的内存和网络带宽都不是瓶颈;

__硬件配置__:

整个测试过程中，唯一变化的是交换机，测试端和服务端不发生变化;

* __硬件交换机__：

    * 内存： 1G
    * CPU : PowerPC P1010 533 MHZ

* __软件交换机__：

    * 内存  :  32G
    * CPU  :  Intel Core i7 8核 3.3 GHZ

__请求处理流程__:

*  __请求处理流程图__：

    ![请求处理流程图](arch.png)
 
     * 预写流表：     所有请求的每一个包都是: 1->6->7->8
     * 不预写流表：   每个请求的第一个包: 1->2->3->转发->4->5->6->7->8; 该请求的后续包：1->6->7->8
     * 负载均衡：     每个请求的第一个包: 1->2->3->负载均衡->4->5->6->7->8; 该请求的后续包：1->6->7->8

     NOTE：软件交换机和硬件交换机主要区别在于上图中的 datapath (数据转发) , 硬件交换由芯片实现;软件交换机是由内核模块实现；

单次请求的响应时间
---------------

* 服务器性能测试：

    Time per request:       1.658 [ms] (mean)

* 软件交换机：

    预写流表：
        Time per request:       2.276 [ms] (mean)

    不预写流表：
        Time per request:       6.057  [ms] (mean)

    负载均衡：
        Time per request:       3.187  [ms] (mean)


* 硬件交换机：

    预写流表：
        Time per request:       1.418 [ms] (mean)

    不预写流表：
        Time per request:       13.943  [ms] (mean)

    负载均衡：
        Requests per second:    1.00 [#/sec] (mean)


服务器性能基准测试
---------------

* __测试拓扑__

    测试端和服务端直连，不经过交换机

    ![服务器性能测试拓扑](topo_bkserver.png)


* __结果图__

    * bkserver : 物理服务器性能,并发数1～1000

    ![服务器性能测试](bkserver.jpg)



* __结果分析__

    * 服务器 TPS 稳定在 5500 左右． 后续测试中, TPS 接近 5000 左右, 都表明受限于服务端的处理能力，而不是该测试的峰值．

　　导致上述结果的可能原因：

    * 服务端 CPU 满载;



软件交换机(OVS)性能测试
---------------

* __测试拓扑__

    测试端和服务端经过软件交换机(OVS)连接

    软件交换机预写流表

    ![软件交换机预写流表](topo_ovs_pw.png)

    软件交换机不预写流表

    ![软件交换机不预写流表](topo_ovs_nw.png)

    软件交换机负载均衡

    ![软件交换机负载均衡](topo_ovs_lb.png)

* __结果图__

    * ovs_nw : 软件交换机,并发数1～1000,不预写流表
    * ovs_pw : 软件交换机,并发数1～1000,预写流表
    * ovs_lb : 软件交换机,并发数1～1000,添加负载均衡

    软件交换机预写流表

    ![软件交换机预写流表](ovs_pw.jpg)

    软件交换机不预写流表

    ![软件交换机不预写流表](ovs_nw.jpg)

    软件交换机负载均衡

    ![软件交换机负载均衡](ovs_lb.jpg)

    软件交换机所有测试结果对比

    ![软件交换机所有测试](ovs_all.jpg)

* __期望结果__

    * 预写流表: 软件交换机转发性能低于服务器性能基准测试中服务端的处理能力，稳定波动后下降．
    * 不预写流表: 软件交换机和控制器的综合处理能力低于服务器性能基准测试中服务端的处理能力，稳定波动后下降．
    * 负载均衡：软件交换机和控制器的综合处理能力低于服务器性能基准测试中服务端的处理能力，稳定波动后下降．


* __结果分析__

    * 在预写流表的情况下，软件交换机转发性能受限于服务端的处理能力. 
    * 在不预写流表情况下，软件交换机和控制器的综合处理能力达到瓶颈
    * 在负载均衡情况下，软件交换机和控制器的综合处理能力受限于服务端的处理能力


    导致上述结果的可能原因：

    * 预写流表  ： 服务端　CPU　高负载; 交换机的 CPU 不是瓶颈;
    * 不预写流表： 服务端　CPU　高负载; 交换机的 CPU 不是瓶颈, 控制器存在优化空间;
    * 负载均衡  ： 服务端　CPU　高负载; 交换机的 CPU 不是瓶颈;

　　 综上所述，从理论上分析，加入负载均衡应该低于预写流表，但受限于服务端的处理能力，目前测试无法测出它们之间的差距;
　　 不预写流表性能应该和负载均衡相当或者更好， 测试结果表明控制器的转发模块的性能仍然存在提升空间．


硬件交换机性能测试
---------------

* __测试拓扑__

    测试端和服务端经过硬件交换机连接

    硬件交换机预写流表

    ![硬件交换机预写流表](topo_v350_pw.png)

    硬件交换机不预写流表

    ![硬件交换机不预写流表](topo_v350_nw.png)

    硬件交换机负载均衡

    ![硬件交换机负载均衡](topo_v350_lb.png)

* __结果图__

    * v350_nw : 硬件交换机,并发数1～1000,不预写流表
    * v350_pw : 硬件交换机,并发数1～1000,预写流表
    * v350_lb : 硬件交换机,并发数1～1000,添加负载均衡

    硬件交换机预写流表

    ![硬件交换机预写流表](v350_pw.jpg)

    硬件交换机不预写流表

    ![硬件交换机不预写流表](v350_nw.jpg)

    硬件交换机负载均衡

    ![硬件交换机负载均衡](v350_lb.jpg)

    硬件交换机所有测试结果对比

    ![硬件交换机所有测试](v350_all.jpg)

* __期望结果__

    * 预写流表: 硬件交换机转发性能低于服务器性能基准测试中服务端的处理能力，稳定波动后下降．
    * 不预写流表: 硬件交换机和控制器的综合处理能力低于服务器性能基准测试中服务端的处理能力，稳定波动后下降．
    * 负载均衡：硬件交换机和控制器的综合处理能力低于服务器性能基准测试中服务端的处理能力，稳定波动后下降．

* __结果分析__

    * 在预写流表的情况下，硬件交换机转发性能受限于服务端的处理能力.
    * 在不预写流表情况下，硬件交换机和控制器的综合处理能力达到瓶颈.
    * 在负载均衡情况下，　硬件交换机和控制器的综合处理能力达到瓶颈

    导致上述结果的可能原因：

    * 预写流表：服务端 CPU 高负载,交换机 CPU 不是瓶颈;
    * 不预写流表：并发超过 100 之后，交换机的 CPU 满载;
    * 负载均衡：并发超过 100 之后,交换机 CPU 高负载; 服务端 CPU 不是瓶颈;

　　综上所述，在预写流表和负载均衡情况下，由于硬件交换机的 CPU 满载，导致硬件交换机和控制器的综合处理能力都达到了瓶颈．


软件交换机与硬件交换机测试性能对比--预写流表
---------------


* __结果图__

    * ovs_pw : 软件交换机,并发数1～1000,pw
    * v350_pw: 硬件交换机,并发数1～1000,pw

    ![预写流表对比](ovs_v350_pw.jpg)



* __结果分析：__

    * 从理论上，软件交换机转发能力不可能和硬件交换机相当，但受限于服务端的处理能力，软件交换机(ovs)与硬件交换机转发能力差距无法看出．

    导致上述结果的可能原因：

    * 服务端 CPU 满载，交换机 CPU 不是瓶颈;


软件交换机与硬件交换机测试性能对比--不预写流表
---------------


* __结果图__

    * ovs_nw : 软件交换机,并发数1～1000,不预写流表
    * v350_nw: 硬件交换机,并发数1～1000,不预写流表

    ![不预写流表对比](ovs_v350_nw.jpg)


* __结果分析：__

    * 软件交换机(ovs)的系统整体性能要高于硬件交换机系统整体性能;

    导致上述结果的可能原因：

    * 软件交换机: 服务端, 交换机 CPU 都不是瓶颈;
    * 硬件交换机：交换机 CPU 满载; 服务端 CPU 不是瓶颈;

综上所述，由于硬件交换机的 CPU 达到瓶颈，而软件交换机的 CPU 没有达到瓶颈，因此，软件交换机的整体性能优于硬件交换机是符合期望的．

软件交换机与硬件交换机测试性能对比--负载均衡模块
--------------

* __结果图__

    * ovs_lb : 软件交换机,并发数1～1000,　添加负载均衡
    * v350_lb: 硬件交换机,并发数1～1000,　添加负载均衡

    ![负载均衡对比](ovs_v350_lb.jpg)


* __结果分析：__

    * 软件交换机(ovs)的系统整体性能要远远优于硬件交换机的系统整体性能;

    导致上述结果的可能原因：

    * 软件交换机 :  交换机 CPU 都不是瓶颈, 服务端达到处理瓶颈
    * 硬件交换机 ：　交换机 CPU 满载; 服务端 CPU 不是瓶颈;

综上所述: 由于硬件交换机的 CPU 达到瓶颈，而软件交换机的 CPU 没有达到瓶颈，因此，软件交换机的整体性能优于硬件交换机是符合期望的．

结论
---------------

在高并发请求的情况下, 软件交换机的系统整体性能优于硬件交换机的系统整体性能,　导致这种结果的主要原因可能是硬件交换机　CPU　处理能力的达到极限；
受限于服务端的处理能力，软件交换机的负载均衡测试并没有达到测试目的．　控制器的转发模块仍然存在性能提升空间．

后续工作
---------------

1. 增加服务端的处理能力, 完善有关测试的真实结果
2. 在更接近实际应用场景下进行测试
3. 完善控制器转发模块的性能调优


附件
--------------

